services:
  # Frontend - Next.js application
  frontend:
    build:
      context: ./client
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
    depends_on:
      - backend
    networks:
      - app-network

  # Backend - FastAPI server with PyGhidra
  backend:
    build:
      context: ./server
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    env_file:
      - ./server/.env
    environment:
      - GHIDRA_INSTALL_DIR=/opt/ghidra
      - GHIDRA_PROJECT_DIR=/tmp/ghidra_projects
      # Limit functions to process (CPU is slow, default 10)
      - MAX_FUNCTIONS=5
      # Set DISABLE_LLM4DECOMPILE=true to skip and use mock transformation
      # - DISABLE_LLM4DECOMPILE=true
    volumes:
      # Mount for temporary files only - no persistent storage of binaries
      - ghidra-temp:/tmp/ghidra_projects
    tmpfs:
      - /tmp:size=1G,mode=1777
    networks:
      - app-network
    # Resource limits - increased for Ghidra analysis
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G

volumes:
  ghidra-temp:
    driver: local

networks:
  app-network:
    driver: bridge
